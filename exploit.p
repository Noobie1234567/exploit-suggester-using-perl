#!/usr/bin/perl

use strict;
use warnings;

# ANSI escape sequences for colors
my $COLOR_RED    = "\e[31m";
my $COLOR_GREEN  = "\e[32m";
my $COLOR_YELLOW = "\e[33m";
my $COLOR_RESET  = "\e[0m";

sub print_banner {
    my $AUTHOR = 'Vishnu Prasadh SR';
    print <<"BANNER";
  ${COLOR_GREEN}Exploit Search Created By $AUTHOR${COLOR_RESET}
  ${COLOR_YELLOW}Searching for exploits based on the local kernel version...${COLOR_RESET}
BANNER
}

sub get_exploits {
    my %exploits = (
        'american-sign-language' => {
            alt => '',
            cve => '2010-4347',
            vuln => ['2.6.32'],
            source => 'http://www.securityfocus.com/bid/45408'
        },
        'can_bcm' => {
            alt => '',
            cve => '2010-2959',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/14814'
        },
        'dirty_cow' => {
            alt => '',
            cve => '2016-5195',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/40616'
        },
        'exploit_x' => {
            alt => '',
            cve => '2018-14665',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/45697'
        },
        'half_nelson1' => {
            alt => 'econet',
            cve => '2010-3848',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/17787'
        },
        'half_nelson2' => {
            alt => 'econet',
            cve => '2010-3850',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/17787'
        },
        'half_nelson3' => {
            alt => 'econet',
            cve => '2010-4073',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/17787'
        },
        'msr' => {
            alt => '',
            cve => '2013-0268',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/27297'
        },
        'pktcdvd' => {
            alt => '',
            cve => '2010-3437',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/15150'
        },
        'ptrace_kmod2' => {
            alt => 'ia32syscall,robert_you_suck',
            cve => '2010-3301',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/15023'
        },
        'rawmodePTY' => {
            alt => '',
            cve => '2014-0196',
            vuln => ['2.6.32'],
            source => 'http://packetstormsecurity.com/files/download/126603/cve-2014-0196-md.c'
        },
        'rds' => {
            alt => '',
            cve => '2010-3904',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/15285'
        },
        'reiserfs' => {
            alt => '',
            cve => '2010-1146',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/12130'
        },
        'video4linux' => {
            alt => '',
            cve => '2010-3081',
            vuln => ['2.6.32'],
            source => 'http://www.exploit-db.com/exploits/15024'
        }
    );
    return \%exploits;
}

sub search_exploits {
    my ($exploits, $kernel) = @_;
    my @vulnerable_exploits;
    foreach my $exploit (keys %$exploits) {
        my $vuln_kernels = $exploits->{$exploit}->{vuln};
        foreach my $vuln_kernel (@$vuln_kernels) {
            if ($vuln_kernel eq $kernel) {
                push @vulnerable_exploits, $exploit;
                last;
            }
        }
    }
    return @vulnerable_exploits;
}

sub is_vulnerable {
    my ($exploits, $kernel) = @_;
    my @vulnerable_exploits = search_exploits($exploits, $kernel);
    return scalar @vulnerable_exploits > 0 ? 1 : 0;
}

sub print_results {
    my ($exploits, $kernel) = @_;
    my @vulnerable_exploits = search_exploits($exploits, $kernel);
    print "\n${COLOR_YELLOW}Possible Exploits${COLOR_RESET}\n";
    for (my $i = 0; $i < scalar @vulnerable_exploits; $i++) {
        my $exploit = $vulnerable_exploits[$i];
        my $cve = $exploits->{$exploit}->{cve};
        my $alt = $exploits->{$exploit}->{alt};
        my $source = $exploits->{$exploit}->{source};
        print "${COLOR_GREEN}[$i] $exploit${COLOR_RESET}";
        print " Alt: $alt" if $alt;
        print "\n";
        print "    ${COLOR_YELLOW}CVE-$cve${COLOR_RESET}\n";
        print "    Source: $source\n";
    }
}

sub download_exploits {
    my ($exploits) = @_;
    print "\n${COLOR_YELLOW}Downloading exploits...${COLOR_RESET}\n";
    foreach my $exploit (keys %$exploits) {
        my $source = $exploits->{$exploit}->{source};
        system("wget -q $source -O $exploit");
    }
    print "${COLOR_GREEN}Exploits downloaded successfully!${COLOR_RESET}\n";
}

sub parse_arguments {
    my ($kernel, $download_mode) = @_;

    if (@ARGV >= 1) {
        $kernel = $ARGV[0];
    } else {
        print "${COLOR_RED}Please specify the kernel version.${COLOR_RESET}\n";
        usage();
        exit 1;
    }

    if (@ARGV >= 2) {
        $download_mode = $ARGV[1];
    }

    return ($kernel, $download_mode);
}

sub usage {
    print <<"USAGE";
  Usage: perl exploit_search.pl [kernel_version] [download]
  
    [kernel_version] : Specify the kernel version to search exploits for (optional)
    [download]       : Set to '1' to download available exploits (optional)
  
  Example: perl exploit_search.pl 2.6.32 1
  
USAGE
}

# Main program
sub main {
    my $kernel = '';
    my $download_mode = 0;

    print_banner();

    ($kernel, $download_mode) = parse_arguments($kernel, $download_mode);

    my $exploits = get_exploits();

    if ($download_mode) {
        download_exploits($exploits);
    } else {
        print "Kernel: $kernel\n";
        if (is_vulnerable($exploits, $kernel)) {
            print_results($exploits, $kernel);
        } else {
            print "\n${COLOR_YELLOW}No exploits are available for this kernel version${COLOR_RESET}\n";
        }
    }
}

main();
